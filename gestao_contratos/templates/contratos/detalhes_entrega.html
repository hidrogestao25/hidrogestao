{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header card-header-custom text-white">
      <h5>üì¶ Detalhes da Entrega - {{ fornecedor.nome }}</h5>
    </div>
    <div class="card-body">
      <p><strong>Descri√ß√£o:</strong> {{ evento.descricao }}</p>
      <p><strong>Data Prevista de Entrega:</strong> {{ evento.data_prevista|date:"d/m/Y" }}</p>
      <p><strong>Data Prevista para Pagamento:</strong> {{ evento.data_prevista_pagamento|date:"d/m/Y" }}</p>
      <p><strong>Valor Previsto:</strong> R$ {{ evento.valor_previsto|floatformat:2 }}</p>

      {% if evento.valor_pago %}
        <p><strong>Valor Pago:</strong> R$ {{ evento.valor_pago|floatformat:2 }}</p>
      {% else %}
        <p><strong>Valor Pago:</strong> - </p>
      {% endif %}

      {% if evento.data_pagamento %}
        <p><strong>Data do Pagamento:</strong> {{ evento.data_pagamento|date:"d/m/Y" }}</p>
      {% else %}
        <p><strong>Data do Pagamento:</strong> - </p>
      {% endif %}

      <p><strong>Status:</strong>
        {% if evento.realizado %}
          ‚úÖ Realizado
        {% else %}
          ‚è≥ Pendente
        {% endif %}
      </p>

      {% if evento.observacao %}
        <p><strong>Observa√ß√µes:</strong> {{ evento.observacao }}</p>
      {% endif %}

    <hr>
    <div class="mb-4">
      <h5>Boletins de Medi√ß√£o Cadastrados</h5>
      {% if bms %}
      <table class="table table-striped mt-2">
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Data do Pagamento</th>
            <th>Valor Pago</th>
            <th>Status Coordenador</th>
            <th>Status Gerente</th>
            <th>Observa√ß√µes</th>
            <th>Arquivo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for bm in bms %}
            <tr id="bm-row-{{ bm.id }}"
                class="{% if bm.status_coordenador == 'reprovado' or bm.status_gerente == 'reprovado' %}table-danger{% elif bm.status_coordenador == 'aprovado' and bm.status_gerente == 'aprovado' %}table-success{% else %}table-warning{% endif %}">
              <td>{{ bm.numero_bm }}</td>
              <td>{{ bm.data_pagamento|date:"d/m/Y" }}</td>
              <td>R$ {{ bm.valor|floatformat:2 }}</td>
              <td>{{ bm.status_coordenador|default:"-" }}</td>
              <td>{{ bm.status_gerente|default:"-" }}</td>
              <td>{% if bm.observacao %}{{ bm.observacao }}{% else %}-{% endif %}</td>
              <td>
                {% if bm.arquivo_bm %}
                  <a href="{{ bm.arquivo_bm.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    Abrir/Download
                  </a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if user.grupo in "coordenador gerente" %}
                  <div class="d-flex gap-1">
                    <button type="button" class="btn btn-sm btn-success btn-aprovar" data-bm-id="{{ bm.id }}">Aprovar</button>
                    <button type="button" class="btn btn-sm btn-danger btn-reprovar" data-bm-id="{{ bm.id }}">Reprovar</button>
                  </div>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="mt-3 text-muted">Nenhum Boletim de Medi√ß√£o cadastrado para este evento.</p>
      {% endif %}
    </div>

    <div class="d-flex justify-content-end gap-2">
      <a href="javascript:history.back()" class="btn btn-custom">‚Üê Voltar</a>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const csrfToken = '{{ csrf_token }}';

  function atualizarLinha(bmId, statusCoordenador, statusGerente) {
    const row = document.getElementById('bm-row-' + bmId);
    if (statusCoordenador === 'reprovado' || statusGerente === 'reprovado') {
      row.className = 'table-danger';
    } else if (statusCoordenador === 'aprovado' && statusGerente === 'aprovado') {
      row.className = 'table-success';
    } else {
      row.className = 'table-warning';
    }
    row.querySelector('td:nth-child(4)').innerText = statusCoordenador || '-';
    row.querySelector('td:nth-child(5)').innerText = statusGerente || '-';
    row.querySelectorAll('.btn-aprovar, .btn-reprovar').forEach(btn => btn.disabled = true);
  }

  document.querySelectorAll('.btn-aprovar, .btn-reprovar').forEach(button => {
    button.addEventListener('click', function() {
      const bmId = this.dataset.bmId;
      const acao = this.classList.contains('btn-aprovar') ? 'aprovar' : 'reprovar';

      fetch("{% url 'avaliar_bm' bm_id=0 %}".replace('0', bmId), {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'acao=' + acao
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          atualizarLinha(bmId, data.status_coordenador, data.status_gerente);
        } else {
          alert('Erro: ' + data.error);
        }
      })
      .catch(err => alert('Erro ao processar a a√ß√£o.'));
    });
  });
});
</script>

{% endblock %}
