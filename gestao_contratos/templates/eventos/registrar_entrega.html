{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      <h5>Registrar Entrega - Evento {{ evento.id }}</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="entregaForm">
        {% csrf_token %}

        <!-- Arquivo -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_arquivo">Arquivo</label>
          {{ form.arquivo }}
        </div>

        <!-- Avaliação -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_avaliacao">Avaliação</label>
          {{ form.avaliacao }}
        </div>

        <!-- Data de entrega -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_entrega">Data de Entrega</label>
          {{ form.data_entrega }}
        </div>

        <!-- Realizado -->
        <div class="mb-3 form-check">
          {{ form.realizado }}
          <label class="form-check-label fw-bold" for="id_realizado">Completamente Finalizado</label>
        </div>

        <!-- Com atraso -->
        <div class="mb-3 form-check">
          {{ form.com_atraso }}
          <label class="form-check-label fw-bold" for="id_com_atraso">Entregue com Atraso</label>
        </div>

        <!-- Data de pagamento -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_pagamento">Data de Pagamento</label>
          {{ form.data_pagamento }}
        </div>

        <!-- Valor Previsto (somente leitura) -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_valor_previsto">Valor Previsto</label>
          <input type="number" id="id_valor_previsto" value="{{ evento.valor_previsto }}" class="form-control" readonly>
        </div>

        <!-- Checkbox -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="check_valor_igual" checked>
          <label class="form-check-label fw-bold" for="check_valor_igual">
            Valor pago é igual ao valor previsto
          </label>
        </div>

        <!-- Campos Valor Pago e Justificativa -->
        <div id="campos_valor_pago_justificativa" style="display: none;">
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_valor_pago">Valor Pago</label>
            {{ form.valor_pago }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_justificativa">Justificativa</label>
            {{ form.justificativa }}
          </div>
        </div>

        <!-- Observação -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_observacao">Observação</label>
          {{ form.observacao }}
        </div>

        <button type="submit" class="btn btn-success">Salvar</button>
        <a href="{% url 'contrato_fornecedor_detalhe' contrato.pk %}" class="btn btn-secondary">Cancelar</a>
      </form>

      <!-- Lista de BMs cadastrados -->
      <div class="mb-4">
        <h5>Boletins de Medição Cadastrados</h5>

        {% if evento.contrato_terceiro.boletins_medicao.exists %}
        <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>Nº BM</th>
            <th>Parcela</th>
            <th>Valor Pago</th>
            <th>Data Pagamento</th>
            <th>Observação</th>
            <th>Arquivo</th>
          </tr>
        </thead>
        <tbody>
          {% for bm in evento.contrato_terceiro.boletins_medicao.all %}
          <tr>
            <td>{{ bm.numero_bm }}</td>
            <td>{{ bm.parcela_paga }}</td>
            <td>R$ {{ bm.valor_pago|floatformat:2 }}</td>
            <td>{{ bm.data_pagamento|date:"d/m/Y" }}</td>
            <td>{{ bm.observacao }}</td>
            <td>
              {% if bm.arquivo_bm %}
                <a href="{{ bm.arquivo_bm.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  Abrir/Download
                </a>
              {% else %}
                <span class="text-muted">Sem arquivo</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        </table>
        {% else %}
          <p class="text-muted">Nenhum boletim cadastrado para este contrato.</p>
        {% endif %}
      </div>
      <!-- Botão para abrir o modal do BM -->
      <hr>
      <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#bmModal">
        Cadastrar BM
      </button>

      <!-- Modal -->
      <div class="modal fade" id="bmModal" tabindex="-1" aria-labelledby="bmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="bmModalLabel">Cadastrar Boletim de Medição</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="bmModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const checkIgual = document.getElementById("check_valor_igual");
    const inputPrevisto = document.getElementById("id_valor_previsto");
    const inputPago = document.getElementById("id_valor_pago");
    const inputJustificativa = document.getElementById("id_justificativa");
    const camposDiv = document.getElementById("campos_valor_pago_justificativa");
    const form = document.getElementById("entregaForm");
    const dataPagamento = document.getElementById("id_data_pagamento");

    // Atualiza campos de Valor Pago / Justificativa
    function atualizarCampos() {
        if (checkIgual.checked) {
            camposDiv.style.display = "none";
            inputPago.value = inputPrevisto.value;
            inputJustificativa.value = "";
            inputJustificativa.required = false;
        } else {
            camposDiv.style.display = "block";
            inputPago.value = inputPrevisto.value;
            inputJustificativa.required = true;
        }
    }
    checkIgual.addEventListener("change", atualizarCampos);
    atualizarCampos();

    // Validação do formulário
    form.addEventListener("submit", function(event) {
        // Garante justificativa se checkbox desmarcado
        if (!checkIgual.checked && !inputJustificativa.value.trim()) {
            alert("Por favor, preencha a justificativa.");
            inputJustificativa.focus();
            event.preventDefault();
            return;
        }

        // Verifica se existem BMs cadastrados para este evento
        const boletins = {{ evento.contrato_terceiro.boletins_medicao.count }};
        if (boletins > 0 && !dataPagamento.value) {
            alert("Por favor, preencha a Data de Pagamento, pois existem BMs cadastrados.");
            dataPagamento.focus();
            event.preventDefault();
            return;
        }
    });

    // Preencher BM Modal
    const bmModal = document.getElementById("bmModal");
    bmModal.addEventListener("show.bs.modal", function() {
        fetch("{% url 'cadastrar_bm' contrato.id %}")
            .then(response => response.text())
            .then(html => {
                document.getElementById("bmModalBody").innerHTML = html;

                // Preenche automaticamente os campos no popup
                const valorPago = document.getElementById("id_valor_pago");
                const dataPagamentoMain = document.getElementById("id_data_pagamento");

                const valorPagoModal = document.querySelector("#bmModalBody #id_valor_pago");
                const dataPagamentoModal = document.querySelector("#bmModalBody #id_data_pagamento");

                if (valorPago && valorPagoModal) {
                    valorPagoModal.value = valorPago.value;
                }
                if (dataPagamentoMain && dataPagamentoModal) {
                    dataPagamentoModal.value = dataPagamentoMain.value;
                }
            });
    });
});
</script>

{% endblock %}
