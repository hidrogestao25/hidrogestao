{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      <h5>Registrar Entrega - Evento {{ evento.id }}</h5>
      <p class="text-muted mb-0">
        Fornecedor: <strong>{{ contrato.empresa_terceira }}</strong>
      </p>
    </div>

    <div class="card-body">
      <!-- FORM PRINCIPAL -->
      <form method="post" enctype="multipart/form-data" id="entregaForm">
        {% csrf_token %}

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_caminho_evidencia">Caminho da Evidência</label>
          {{ form.caminho_evidencia }}
          {% if form.caminho_evidencia.errors %}
            <div class="text-danger small">{{ form.caminho_evidencia.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_avaliacao">Avaliação</label>
          {{ form.avaliacao }}
          {% if form.avaliacao.errors %}
            <div class="text-danger small">{{ form.avaliacao.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_entrega">Data de Entrega</label>
          {{ form.data_entrega }}
          {% if form.data_entrega.errors %}
            <div class="text-danger small">{{ form.data_entrega.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3 form-check">
          {{ form.realizado }}
          <label class="form-check-label fw-bold" for="id_realizado">
            Completamente Finalizado
          </label>
          {% if form.realizado.errors %}
            <div class="text-danger small">{{ form.realizado.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3 form-check">
          {{ form.com_atraso }}
          <label class="form-check-label fw-bold" for="id_com_atraso">
            Entregue com Atraso
          </label>
          {% if form.com_atraso.errors %}
            <div class="text-danger small">{{ form.com_atraso.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_pagamento">Data de Pagamento</label>
          {{ form.data_pagamento }}
          {% if form.data_pagamento.errors %}
            <div class="text-danger small">{{ form.data_pagamento.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Valor Previsto</label>
          <input type="text" class="form-control" value="{{ evento.valor_previsto }}" readonly>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="check_valor_igual" name="valor_igual" checked>
          <label class="form-check-label fw-bold" for="check_valor_igual">
            Valor pago é igual ao valor previsto
          </label>
        </div>

        <div id="campos_valor_pago_justificativa" style="display: none;">
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_valor_pago">Valor Pago</label>
            {{ form.valor_pago }}
            {% if form.valor_pago.errors %}
              <div class="text-danger small">{{ form.valor_pago.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold" for="id_justificativa">Justificativa</label>
            {{ form.justificativa }}
            {% if form.justificativa.errors %}
              <div class="text-danger small">{{ form.justificativa.errors }}</div>
            {% endif %}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_observacao">Observação</label>
          {{ form.observacao }}
          {% if form.observacao.errors %}
            <div class="text-danger small">{{ form.observacao.errors }}</div>
          {% endif %}
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'contrato_fornecedor_detalhe' contrato.pk %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>

      <!-- LISTA DE BMs -->
      <hr>
      <div class="mb-4">
        <h5>Boletins de Medição Cadastrados</h5>

        {% if boletins_detalhados %}
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Nº BM</th>
              <th>Parcela</th>
              <th>Valor Pago</th>
              <th>Data Pagamento</th>
              <th>Status Coordenador</th>
              {% if has_reprovacao_coordenador %}
                <th>Justificativa Coordenador</th>
              {% endif %}
              <th>Status Gerente</th>
              {% if has_reprovacao_gerente %}
                <th>Justificativa Gerente</th>
              {% endif %}

              <th>Observação</th>
              <th>Arquivo</th>

              {% if request.user.grupo == 'coordenador' or request.user.grupo == 'suprimento' %}
              <th>Ações</th>
              {% endif %}
            </tr>
          </thead>

          <tbody id="lista-bms">
            {% for item in boletins_detalhados %}
              <tr id="bm-row-{{ item.bm.id }}" class="{{ item.row_class }}">

                <td>{{ item.bm.numero_bm }}</td>
                <td>{{ item.bm.parcela_paga }}</td>
                <td>R$ {{ item.bm.valor_pago|floatformat:2 }}</td>
                <td>{{ item.bm.data_pagamento|date:"d/m/Y" }}</td>

                {% if bm.status_coordenador == "aprovado" %}
                  <td><span class="badge bg-success">Aprovado</span></td>
                {% elif bm.status_coordenador == "reprovado" %}
                  <td><span class="badge bg-danger">Reprovado</span></td>
                {% else %}
                  <td><span class="badge bg-secondary">Pendente</span></td>
                {% endif %}

                {% if has_reprovacao_coordenador %}
                  <td>
                    {% if item.bm.status_coordenador == 'reprovado' %}
                      {{ item.bm.justificativa_reprovacao_coordenador }}
                    {% else %}-{% endif %}
                  </td>
                {% endif %}

                {% if bm.status_gerente == "aprovado" %}
                  <td><span class="badge bg-success">Aprovado</span></td>
                {% elif bm.status_gerente == "reprovado" %}
                  <td><span class="badge bg-danger">Reprovado</span></td>
                {% else %}
                  <td><span class="badge bg-secondary">Pendente</span></td>
                {% endif %}

                {% if has_reprovacao_gerente %}
                  <td>
                    {% if item.bm.status_gerente == 'reprovado' %}
                      {{ item.bm.justificativa_reprovacao_gerente }}
                    {% else %}-{% endif %}
                  </td>
                {% endif %}

                <td>{{ item.bm.observacao|default:"-" }}</td>

                <td>
                  {% if item.bm.arquivo_bm %}
                    <a href="{{ item.bm.arquivo_bm.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                      Abrir/Download
                    </a>
                  {% else %}
                    <span class="text-muted">Sem arquivo</span>
                  {% endif %}
                </td>

                {% if request.user.grupo == 'coordenador' %}
                <td>
                  <div class="d-flex gap-1">

                    <button type="button"
                      class="btn btn-sm btn-success btn-aprovar"
                      data-bm-id="{{ item.bm.id }}"
                      {% if item.bm.status_coordenador != "pendente" %}
                        disabled
                      {% endif %}
                    >Aprovar</button>

                    <button type="button"
                      class="btn btn-sm btn-danger btn-reprovar"
                      data-bm-id="{{ item.bm.id }}"
                      {% if item.bm.status_coordenador != "pendente" %}
                        disabled
                      {% endif %}
                    >Reprovar</button>

                  </div>
                </td>
                {% endif %}

                {% if request.user.grupo == 'suprimento' %}
                <td>
                  <div class="d-flex gap-1">

                    <button class="btn btn-sm btn-warning btn-editar-bm"
                            data-bm-id="{{ item.bm.id }}"
                            data-bs-toggle="modal"
                            data-bs-target="#editarBMModal">
                        Editar
                    </button>


                    <form method="post" action="{% url 'deletar_bm' item.bm.id %}"
                          onsubmit="return confirm('Tem certeza que deseja apagar este BM?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger">
                        Apagar
                      </button>
                    </form>

                  </div>
                </td>
                {% endif %}

              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% else %}
          <p class="text-muted">Nenhum boletim cadastrado para este evento.</p>
        {% endif %}
      </div>

      <hr>
      <h5>Notas Fiscais Cadastradas</h5>

      {% if notas_fiscais %}
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>ID NF</th>
            <th>BM</th>
            <th>Parcela</th>
            <th>Valor Pago</th>
            <th>Data Pagamento</th>
            <th>Observação</th>
            <th>Arquivo</th>
            {% if request.user.grupo == 'suprimento' or request.user.grupo == 'coordenador' %}
              <th>Ações</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% for nf in notas_fiscais %}
          <tr>
            <td>{{ nf.id }}</td>
            <td>{{ nf.bm.numero_bm }}</td>
            <td>{{ nf.parcela_paga }}</td>
            <td>R$ {{ nf.valor_pago|floatformat:2 }}</td>
            <td>{{ nf.data_pagamento|date:"d/m/Y" }}</td>
            <td>{{ nf.observacao|default:"-" }}</td>
            <td>
              {% if nf.arquivo_nf %}
                <a href="{{ nf.arquivo_nf.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                  Abrir/Download
                </a>
              {% else %}
                <span class="text-muted">Sem arquivo</span>
              {% endif %}
            </td>

            {% if request.user.grupo == 'suprimento' or request.user.grupo == 'coordenador' %}
            <td>
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-warning btn-editar-nf"
                        data-nf-id="{{ nf.id }}"
                        data-bs-toggle="modal"
                        data-bs-target="#editarNFModal">
                    Editar
                </button>

                <form method="post" action="{% url 'deletar_nf' nf.id %}"
                      onsubmit="return confirm('Tem certeza que deseja apagar esta NF?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">Apagar</button>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Nenhuma Nota Fiscal cadastrada para este evento.</p>
      {% endif %}



      {% if request.user.grupo == 'suprimento' %}
      <button type="button" class="btn btn-primary mt-3"
              data-bs-toggle="modal"
              data-bs-target="#bmModal">Cadastrar BM</button>

      <!-- Modal BM -->
      <div class="modal fade" id="bmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Cadastrar Boletim de Medição</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="bmModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>

          </div>
        </div>
      </div>
      {% endif %}
      {% if request.user.grupo == 'suprimento' %}
      <button type="button" class="btn btn-info mt-3"
              data-bs-toggle="modal"
              data-bs-target="#nfModal">Cadastrar NF</button>

      <!-- Modal NF -->
      <div class="modal fade" id="nfModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-info text-white">
              <h5 class="modal-title">Cadastrar Nota Fiscal</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="nfModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>

          </div>
        </div>
      </div>

      <!-- Modal Editar NF -->
      <div class="modal fade" id="editarNFModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title">Editar Nota Fiscal</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="editarNFModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>

          </div>
        </div>
      </div>

      <!-- Modal Editar BM -->
      <div class="modal fade" id="editarBMModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title">Editar BM</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="editarBMModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>
          </div>
        </div>
      </div>

      {% endif %}



    </div>
  </div>
</div>

<!-- MODAL JUSTIFICATIVA -->
<div class="modal fade" id="modalJustificativa" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Justificativa da Reprovação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label class="form-label">Explique o motivo da reprovação:</label>
        <textarea id="justificativaTexto" class="form-control" rows="4"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnConfirmarReprovar" class="btn btn-danger">Confirmar Reprovação</button>
      </div>

    </div>
  </div>
</div>


<!-- SCRIPTS -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  /* ------------------------
      VALOR PAGO / PREVISTO
  ------------------------ */
  const checkIgual = document.getElementById("check_valor_igual");
  const camposDiv = document.getElementById("campos_valor_pago_justificativa");
  const inputJustificativa = document.getElementById("id_justificativa");
  const inputValorPago = document.getElementById("id_valor_pago");

  function atualizarCampos() {
    if (checkIgual.checked) {
      camposDiv.style.display = "none";
      if (inputValorPago) inputValorPago.value = "{{ evento.valor_previsto|default:0 }}";
      if (inputJustificativa) inputJustificativa.required = false;
    } else {
      camposDiv.style.display = "block";
      if (inputJustificativa) inputJustificativa.required = true;
    }
  }

  checkIgual.addEventListener("change", atualizarCampos);
  atualizarCampos();



  /* ------------------------
      MODAL CADASTRO BM
  ------------------------ */
  const bmModal = document.getElementById("bmModal");

  if (bmModal) {
    bmModal.addEventListener("show.bs.modal", function() {
      fetch("{% url 'cadastrar_bm' contrato.id evento.id %}")
        .then(r => r.text())
        .then(html => {

          document.getElementById("bmModalBody").innerHTML = html;

          const bmForm = document.getElementById("bmForm");

          bmForm.addEventListener("submit", function(e) {
            e.preventDefault();

            const fd = new FormData(bmForm);

            fetch("{% url 'cadastrar_bm' contrato.id evento.id %}", {
              method: "POST",
              body: fd,
              headers: {"X-Requested-With": "XMLHttpRequest"}
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                bootstrap.Modal.getInstance(bmModal).hide();
                location.reload();
              } else {
                alert(Object.values(data.errors).flat().join("\n"));
              }
            });

          });

        });
    });
  }

  /* ------------------------
        MODAL EDITAR BM
  ------------------------ */

  const editarBMModal = document.getElementById("editarBMModal");

  document.querySelectorAll(".btn-editar-bm").forEach(btn => {

    btn.addEventListener("click", function() {

      const bmId = this.dataset.bmId;

      fetch(`/bm/${bmId}/editar/`)
        .then(r => r.text())
        .then(html => {

          document.getElementById("editarBMModalBody").innerHTML = html;

          const form = document.getElementById("formEditarBM");

          document.getElementById("btnSalvarBM")?.addEventListener("click", function () {

            const fd = new FormData(form);

            fetch(`/bm/${bmId}/editar/`, {
              method: "POST",
              body: fd,
              headers: {
                "X-CSRFToken": csrfToken
              }
            })
            .then(r => r.json())
            .then(data => {

              if (data.success) {
                bootstrap.Modal.getInstance(editarBMModal).hide();
                location.reload();
              } else {
                alert(Object.values(data.errors || {}).flat().join("\n"));
              }

            })
            .catch(error => {
              console.error("Erro:", error);
              alert("Erro ao salvar.");
            });

          });

        });

    });

  });


  /* ------------------------
      MODAL CADASTRO NF
  ------------------------ */
  const nfModal = document.getElementById("nfModal");

  if (nfModal) {
    nfModal.addEventListener("show.bs.modal", function() {

      fetch("{% url 'cadastrar_nf' evento.id %}")
        .then(r => r.text())
        .then(html => {

          document.getElementById("nfModalBody").innerHTML = html;

          const nfForm = document.getElementById("nfForm");

          nfForm.addEventListener("submit", function(e) {
            e.preventDefault();

            const fd = new FormData(nfForm);

            fetch("{% url 'cadastrar_nf' evento.id %}", {
              method: "POST",
              body: fd,
              headers: {"X-Requested-With": "XMLHttpRequest"}
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                bootstrap.Modal.getInstance(nfModal).hide();
                location.reload();
              } else {
                alert(Object.values(data.errors).flat().join("\n"));
              }
            });
          });

        });
    });
  }

  /* ------------------------
        MODAL EDITAR NF
  ------------------------ */

  const editarNFModal = document.getElementById("editarNFModal");

  document.querySelectorAll(".btn-editar-nf").forEach(btn => {
    btn.addEventListener("click", function() {
      const nfId = this.dataset.nfId;

      fetch(`/evento/${nfId}/editar-nf/`)  // ou {% url 'editar_nf' 0 %}.replace("0", nfId)
        .then(r => r.text())
        .then(html => {
          document.getElementById("editarNFModalBody").innerHTML = html;

          const form = document.getElementById("formEditarNF");

          document.getElementById("btnSalvarNF")?.addEventListener("click", function () {
              const fd = new FormData(form);

              fetch(`/evento/${nfId}/editar-nf/`, {
                  method: "POST",
                  body: fd
              })
              .then(r => r.json())
              .then(data => {
                  if (data.success) {
                      bootstrap.Modal.getInstance(editarNFModal).hide();
                      location.reload();
                  } else {
                      alert("Erro: " + JSON.stringify(data.errors));
                  }
              });
          });
        });
    });
  });
  /* ------------------------
      APROVAÇÃO / REPROVAÇÃO
  ------------------------ */

  const csrfToken = "{{ csrf_token }}";
  let bmReprovandoId = null;

  function atualizarLinha(bmId, statusCoordenador, statusGerente) {
    const row = document.getElementById("bm-row-" + bmId);
    if (!row) return;

    if (statusCoordenador === "reprovado" || statusGerente === "reprovado") {
      row.className = "table-danger";
    } else if (statusCoordenador === "aprovado" && statusGerente === "aprovado") {
      row.className = "table-success";
    } else {
      row.className = "table-warning";
    }

    row.querySelector(".status-coordenador").innerText = statusCoordenador || "-";
    row.querySelector(".status-gerente").innerText = statusGerente || "-";

    row.querySelectorAll(".btn-aprovar, .btn-reprovar").forEach(btn => btn.disabled = true);
  }


  document.querySelectorAll(".btn-aprovar, .btn-reprovar").forEach(btn => {

    btn.addEventListener("click", function() {
      const bmId = this.dataset.bmId;
      const acao = this.classList.contains("btn-aprovar") ? "aprovar" : "reprovar";

      if (acao === "reprovar") {
        bmReprovandoId = bmId;
        new bootstrap.Modal(document.getElementById("modalJustificativa")).show();
      } else {
        enviarAvaliacao(bmId, acao, "");
      }
    });

  });


  function enviarAvaliacao(bmId, acao, justificativa) {
    fetch("{% url 'avaliar_bm' bm_id=0 %}".replace("0", bmId), {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({acao, justificativa})
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        atualizarLinha(bmId, data.status_coordenador, data.status_gerente);
      } else {
        alert("Erro: " + data.error);
      }
    });
  }


  document.getElementById("btnConfirmarReprovar").addEventListener("click", () => {

    const just = document.getElementById("justificativaTexto").value.trim();

    if (!just) {
      alert("Por favor, insira uma justificativa.");
      return;
    }

    bootstrap.Modal.getInstance(document.getElementById("modalJustificativa")).hide();
    enviarAvaliacao(bmReprovandoId, "reprovar", just);
  });


});
</script>

{% endblock %}
