{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      <h5>Registrar Entrega - Evento {{ evento.id }}</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="entregaForm">
        {% csrf_token %}

        <!-- Arquivo -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_arquivo">Arquivo</label>
          {{ form.arquivo }}
        </div>

        <!-- Avaliação -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_avaliacao">Avaliação</label>
          {{ form.avaliacao }}
        </div>

        <!-- Data de entrega -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_entrega">Data de Entrega</label>
          {{ form.data_entrega }}
        </div>

        <!-- Realizado -->
        <div class="mb-3 form-check">
          {{ form.realizado }}
          <label class="form-check-label fw-bold" for="id_realizado">Completamente Finalizado</label>
        </div>

        <!-- Com atraso -->
        <div class="mb-3 form-check">
          {{ form.com_atraso }}
          <label class="form-check-label fw-bold" for="id_com_atraso">Entregue com Atraso</label>
        </div>

        <!-- Data de pagamento -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_pagamento">Data de Pagamento</label>
          {{ form.data_pagamento }}
        </div>

        <!-- Valor Previsto (somente leitura) -->
        <div class="mb-3">
          <label class="form-label fw-bold">Valor Previsto</label>
          <input type="text" class="form-control" value="{{ evento.valor_previsto }}" readonly>
        </div>

        <!-- Checkbox -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="check_valor_igual" checked>
          <label class="form-check-label fw-bold" for="check_valor_igual">
            Valor pago é igual ao valor previsto
          </label>
        </div>

        <!-- Campos Valor Pago e Justificativa -->
        <div id="campos_valor_pago_justificativa" style="display: none;">
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_valor_pago">Valor Pago</label>
            {{ form.valor_pago }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_justificativa">Justificativa</label>
            {{ form.justificativa }}
          </div>
        </div>

        <!-- Observação -->
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_observacao">Observação</label>
          {{ form.observacao }}
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'contrato_fornecedor_detalhe' contrato.pk %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>

      <!-- Lista de Boletins de Medição -->
      <hr>
      <div class="mb-4">
      <h5>Boletins de Medição Cadastrados</h5>
      {% if boletins %}
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>Nº BM</th>
            <th>Parcela</th>
            <th>Valor Pago</th>
            <th>Data Pagamento</th>
            <th>Observação</th>
            <th>Arquivo</th>
          </tr>
        </thead>
        <tbody id="lista-bms">
          {% for bm in evento.boletins_medicao.all %}
          <tr>
            <td>{{ bm.numero_bm }}</td>
            <td>{{ bm.parcela_paga }}</td>
            <td>R$ {{ bm.valor_pago|floatformat:2 }}</td>
            <td>{{ bm.data_pagamento|date:"d/m/Y" }}</td>
            <td>{{ bm.observacao }}</td>
            <td>
              {% if bm.arquivo_bm %}
                <a href="{{ bm.arquivo_bm.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  Abrir/Download
                </a>
              {% else %}
                <span class="text-muted">Sem arquivo</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-muted">Nenhum boletim cadastrado para este evento.</p>
      {% endif %}
    </div>


      <!-- Botão para abrir o modal -->
      <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#bmModal">
        Cadastrar BM
      </button>

      <!-- Modal -->
      <div class="modal fade" id="bmModal" tabindex="-1" aria-labelledby="bmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="bmModalLabel">Cadastrar Boletim de Medição</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="bmModalBody">
              <div class="text-center p-4">Carregando...</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Checkbox Valor Pago
  const checkIgual = document.getElementById("check_valor_igual");
  const camposDiv = document.getElementById("campos_valor_pago_justificativa");
  const inputJustificativa = document.getElementById("id_justificativa");
  const inputValorPago = document.getElementById("id_valor_pago");

  function atualizarCampos() {
    if (checkIgual.checked) {
      camposDiv.style.display = "none";
      if (inputValorPago) {
        inputValorPago.value = {{ evento.valor_previsto|default:0 }};
      }
      if (inputJustificativa) inputJustificativa.required = false;
    } else {
      camposDiv.style.display = "block";
      if (inputJustificativa) inputJustificativa.required = true;
    }
  }
  checkIgual.addEventListener("change", atualizarCampos);
  atualizarCampos();

  // Carrega o conteúdo do popup do BM via fetch
  const bmModal = document.getElementById("bmModal");
  bmModal.addEventListener("show.bs.modal", function() {
    fetch("{% url 'cadastrar_bm' contrato.id evento.id %}")
      .then(response => response.text())
      .then(html => {
        document.getElementById("bmModalBody").innerHTML = html;

        // Captura o form do modal e adiciona submit via Ajax
        const bmForm = document.getElementById("bmForm");
        bmForm.addEventListener("submit", function(e) {
          e.preventDefault();
          const formData = new FormData(bmForm);
          const url = "{% url 'cadastrar_bm' contrato.id evento.id %}";

          fetch(url, {
            method: "POST",
            body: formData,
            headers: {"X-Requested-With": "XMLHttpRequest"}
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              const modalInstance = bootstrap.Modal.getInstance(bmModal);
              modalInstance.hide();
              location.reload();
            } else {
              let errors = "";
              for (const [field, msgs] of Object.entries(data.errors)) {
                errors += msgs.join("\n") + "\n";
              }
              alert("Erros:\n" + errors);
            }
          })
          .catch(err => console.error(err));
        });
      });
  });
});
</script>
{% endblock %}
