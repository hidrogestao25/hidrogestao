{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      <h5>Registrar Entrega - Evento {{ evento.id }}</h5>
      <p class="text-muted mb-0">
        Fornecedor: <strong>{{ contrato.empresa_terceira }}</strong>
      </p>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="entregaForm">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label fw-bold" for="id_arquivo">Arquivo</label>
          {{ form.arquivo }}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_avaliacao">Avaliação</label>
          {{ form.avaliacao }}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_entrega">Data de Entrega</label>
          {{ form.data_entrega }}
        </div>

        <div class="mb-3 form-check">
          {{ form.realizado }}
          <label class="form-check-label fw-bold" for="id_realizado">Completamente Finalizado</label>
        </div>

        <div class="mb-3 form-check">
          {{ form.com_atraso }}
          <label class="form-check-label fw-bold" for="id_com_atraso">Entregue com Atraso</label>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_data_pagamento">Data de Pagamento</label>
          {{ form.data_pagamento }}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Valor Previsto</label>
          <input type="text" class="form-control" value="{{ evento.valor_previsto }}" readonly>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="check_valor_igual" checked>
          <label class="form-check-label fw-bold" for="check_valor_igual">
            Valor pago é igual ao valor previsto
          </label>
        </div>

        <div id="campos_valor_pago_justificativa" style="display: none;">
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_valor_pago">Valor Pago</label>
            {{ form.valor_pago }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" for="id_justificativa">Justificativa</label>
            {{ form.justificativa }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold" for="id_observacao">Observação</label>
          {{ form.observacao }}
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'contrato_fornecedor_detalhe' contrato.pk %}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>

      <!-- Lista de Boletins -->
      <hr>
      <div class="mb-4">
        <h5>Boletins de Medição Cadastrados</h5>
        {% if boletins_detalhados %}
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Nº BM</th>
              <th>Parcela</th>
              <th>Valor Pago</th>
              <th>Data Pagamento</th>
              <th>Status Coordenador</th>
              <th>Status Gerente</th>
              {% if has_reprovacao_coordenador %}
                <th>Justificativa Coordenador</th>
              {% endif %}
              {% if has_reprovacao_gerente %}
                <th>Justificativa Gerente</th>
              {% endif %}
              <th>Observação</th>
              <th>Arquivo</th>
            </tr>
          </thead>
          <tbody id="lista-bms">
            {% for item in boletins_detalhados %}
              <tr class="{{ item.row_class }}">
                <td>{{ item.bm.numero_bm }}</td>
                <td>{{ item.bm.parcela_paga }}</td>
                <td>R$ {{ item.bm.valor_pago|floatformat:2 }}</td>
                <td>{{ item.bm.data_pagamento|date:"d/m/Y" }}</td>
                <td>{{ item.bm.status_coordenador|capfirst }}</td>
                <td>{{ item.bm.status_gerente|capfirst }}</td>
                {% if has_reprovacao_coordenador %}
                  <td>
                    {% if item.bm.status_coordenador == 'reprovado' %}
                      {{ item.bm.justificativa_reprovacao_coordenador }}
                    {% else %}-{% endif %}
                  </td>
                {% endif %}
                {% if has_reprovacao_gerente %}
                  <td>
                    {% if item.bm.status_gerente == 'reprovado' %}
                      {{ item.bm.justificativa_reprovacao_gerente }}
                    {% else %}-{% endif %}
                  </td>
                {% endif %}
                <td>{{ item.bm.observacao|default:"-" }}</td>
                <td>
                  {% if item.bm.arquivo_bm %}
                    <a href="{{ item.bm.arquivo_bm.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                      Abrir/Download
                    </a>
                  {% else %}
                    <span class="text-muted">Sem arquivo</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="text-muted">Nenhum boletim cadastrado para este evento.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const checkIgual = document.getElementById("check_valor_igual");
  const camposDiv = document.getElementById("campos_valor_pago_justificativa");
  const inputJustificativa = document.getElementById("id_justificativa");
  const inputValorPago = document.getElementById("id_valor_pago");

  function atualizarCampos() {
    if (checkIgual.checked) {
      camposDiv.style.display = "none";
      if (inputValorPago) inputValorPago.value = {{ evento.valor_previsto|default:0 }};
      if (inputJustificativa) inputJustificativa.required = false;
    } else {
      camposDiv.style.display = "block";
      if (inputJustificativa) inputJustificativa.required = true;
    }
  }

  checkIgual.addEventListener("change", atualizarCampos);
  atualizarCampos();
});
</script>
{% endblock %}
