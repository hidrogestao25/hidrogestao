{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Detalhes da Solicitação</h2>

    <!-- Dados gerais da solicitação -->
    <table class="table table-bordered">
        <tr>
            <th>Contrato</th>
            <td>{{ solicitacao.contrato }}</td>
        </tr>
        <tr>
            <th>Líder Técnico</th>
            <td>{{ solicitacao.coordenador.get_full_name|default:solicitacao.coordenador }}</td>
        </tr>
        <tr>
            <th>Líder de Contrato</th>
            <td>{{ solicitacao.lider_contrato.get_full_name|default:solicitacao.lider_contrato }}</td>
        </tr>
        <tr>
            <th>Descrição</th>
            <td>{{ solicitacao.descricao }}</td>
        </tr>
        <tr>
            <th>Previsto no Orçamento</th>
            <td>{% if solicitacao.previsto_no_orcamento %}✔️{% else %}<span style="color:red;">✖</span>{% endif %}</td>
        </tr>
        <tr>
            <th>Valor Provisionado</th>
            <td>{{ solicitacao.valor_provisionado }}</td>
        </tr>
        <tr>
            <th>Valor Vendido</th>
            <td>{{ solicitacao.valor_vendido }}</td>
        </tr>
        <tr>
            <th>Data da Solicitação</th>
            <td>{{ solicitacao.data_solicitacao|date:"d/m/Y H:i" }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>{{ solicitacao.status }}</td>
        </tr>
        <tr>
            <th>Triagem Realizada</th>
            <td>{% if solicitacao.triagem_realizada %}✔️{% else %}<span style="color:red;">✖</span>{% endif %}</td>
        </tr>
    </table>


    <!-- Fornecedor escolhido e proposta -->
    {% if fornecedor_escolhido %}
    <div class="card mb-3">
        <div class="card-header">Fornecedor Escolhido</div>
        <div class="card-body">
            <p><strong>Nome:</strong> {{ fornecedor_escolhido.nome }}</p>
            <p><strong>Setor de Atuação:</strong> {{ fornecedor_escolhido.setor_de_atuacao }}</p>
            {% if proposta_escolhida %}
                <p><strong>Valor da Proposta:</strong> R$ {{ proposta_escolhida.valor_proposta|floatformat:2 }}</p>
                <p><strong>Prazo de Validade:</strong> {{ proposta_escolhida.prazo_validade|date:"d/m/Y" }}</p>
                {% if proposta_escolhida.arquivo_proposta %}
                    <p><a href="{{ proposta_escolhida.arquivo_proposta.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver Proposta em PDF</a></p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Documento do contrato -->
    {% if contrato_doc %}
    <div class="card mb-3">
        <div class="card-header">Contrato desenvolvido pelo Financeiro</div>
        <div class="card-body">
            <p><strong>Número do Contrato:</strong> {{ contrato_doc.numero_contrato }}</p>
            <p><strong>Objeto:</strong> {{ contrato_doc.objeto }}</p>
            <p><strong>Prazo de Início:</strong> {{ contrato_doc.prazo_inicio|date:"d/m/Y" }}</p>
            <p><strong>Prazo de Fim:</strong> {{ contrato_doc.prazo_fim|date:"d/m/Y" }}</p>
            <p><strong>Valor Total:</strong> R$ {{ contrato_doc.valor_total|floatformat:2 }}</p>
            {% if contrato_doc.arquivo_contrato %}
                <a href="{{ contrato_doc.arquivo_contrato.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver Contrato em PDF</a>
            {% endif %}
            {% if solicitacao.aprovacao_gerencia == True %}
              <span class="badge bg-success me-1">✔️ Aprovado</span>
            {% elif solicitaca.reprovacao_gerencia == True %}
              <span class="badge bg-warning text-dark me-1">✖ Reprovado</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Justificativa e aprovação da gerência -->
    {% if request.user.grupo == 'gerente_contrato' and contrato_doc %}
      {% if solicitacao.aprovacao_gerencia == False and solicitacao.reprovacao_gerencia == False %}
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="justificativa" class="form-label">Justificativa (se reprovar)</label>
                <textarea class="form-control" name="justificativa" id="justificativa" rows="3"></textarea>
            </div>
            <button type="submit" name="acao" value="aprovar" class="btn btn-success">Aprovar</button>
            <button type="submit" name="acao" value="reprovar" class="btn btn-danger">Reprovar</button>
        </form>
      {% endif %}
    {% endif %}

    <a href="{% url 'lista_solicitacoes' %}" class="btn btn-secondary mt-3">Voltar</a>
</div>

{% endblock %}
