{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Previsão de Pagamentos</h2>
  <p>Selecione uma data para visualizar os pagamentos previstos até ela.</p>

  <form method="get" class="mb-4">
    <div class="row align-items-end">

      <!-- Campo de Data Inicial -->
      <div class="col-md-3">
        <label for="{{ form.data_inicial.id_for_label }}" class="form-label">
          Data Inicial
          <i class="bi bi-info-circle" title="Data a partir da qual os pagamentos serão considerados. Se não preencher, será usada a data de hoje."></i>
        </label>
        {{ form.data_inicial }}
      </div>

      <!-- Campo de Data Limite -->
      <div class="col-md-3">
        <label for="{{ form.data_limite.id_for_label }}" class="form-label">
          Data Limite
          <i class="bi bi-info-circle" title="Última data a considerar nos filtros de previsão e pagamento."></i>
        </label>
        {{ form.data_limite }}
      </div>

      <!-- Campo de Coordenador -->
      <div class="col-md-4">
        <label for="{{ form.coordenador.id_for_label }}" class="form-label">
          Coordenador
          <i class="bi bi-info-circle" title="Filtra apenas os contratos associados ao coordenador selecionado. Deixe em branco para incluir todos."></i>
        </label>
        {{ form.coordenador }}
      </div>

      <!-- Botão de Filtrar -->
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100 mt-2">Filtrar</button>
      </div>
    </div>
  </form>


  {% if pagamentos %}
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Projeto</th>
          <th>Projeto</th>
          <th>Fornecedor</th>
          <th>Data Prevista</th>
          <th>Valor Previsto</th>
          <th>Data Pagamento</th>
          <th>Valor Pago</th>
        </tr>
      </thead>
      <tbody>
        {% for item in pagamentos %}
        <tr>
          <td>{{ item.contrato_terceiro__cod_projeto__cod_projeto }}</td>
          <td>{{ item.contrato_terceiro__coordenador__username }}</td>
          <td>{{ item.empresa_terceira__nome }}</td>
          <td>{{ item.data_prevista_pagamento|date:"d/m/Y" }}</td>
          <td>R$ {{ item.valor_previsto|floatformat:2 }}</td>
          <td>{% if item.data_pagamento %}{{ item.data_pagamento|date:"d/m/Y" }}{% endif %}</td>
          <td>R$ {{ item.valor_pago|floatformat:2 }}</td>
        </tr>
        {% endfor %}
        <tr class="fw-bold">
          <td colspan="4">Total Geral</td>
          <td>R$ {{ total_previsto|floatformat:2 }}</td>
          <td></td>
          <td>R$ {{ total_pago|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>

    {% if grafico_html %}
      <h4 class="mt-5">Gráfico de Pagamentos Acumulados</h4>
      {{ grafico_html|safe }}
    {% endif %}

  {% elif form.is_bound %}
    <div class="alert alert-warning">Nenhum pagamento previsto até esta data.</div>
  {% endif %}
</div>

{% if grafico_barra %}
  <div class="mt-5">
    <h4>Pagamentos Previsto x Pago (Últimos 12 meses e Próximos 12 meses)</h4>
    {{ grafico_barra|safe }}
  </div>
{% endif %}
{% endblock %}
