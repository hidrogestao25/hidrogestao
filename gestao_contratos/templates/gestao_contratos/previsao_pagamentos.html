{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Previs√£o de Pagamentos</h2>
  <p>Selecione uma data para visualizar os pagamentos previstos at√© ela.</p>

  <form method="get" class="mb-4">
    <div class="row align-items-end">
      <div class="col-md-3">
        <label for="{{ form.data_inicial.id_for_label }}" class="form-label">
          Data Inicial
          <i class="bi bi-info-circle" title="Data a partir da qual os pagamentos ser√£o considerados. Se n√£o preencher, ser√° usada a data de hoje."></i>
        </label>
        {{ form.data_inicial }}
      </div>

      <div class="col-md-3">
        <label for="{{ form.data_limite.id_for_label }}" class="form-label">
          Data Limite
          <i class="bi bi-info-circle" title="√öltima data a considerar nos filtros de previs√£o e pagamento."></i>
        </label>
        {{ form.data_limite }}
      </div>

      <div class="col-md-4">
        <label for="{{ form.coordenador.id_for_label }}" class="form-label">
          Coordenador
          <i class="bi bi-info-circle" title="Filtra apenas os contratos associados ao coordenador selecionado. Deixe em branco para incluir todos."></i>
        </label>
        {{ form.coordenador }}
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100 mt-2">Filtrar</button>
      </div>
    </div>
  </form>


  {% if pagamentos %}
  <div class="d-flex justify-content-end mb-3">
    <a href="{% url 'exportar_previsao_pagamentos_excel' %}?{{ request.GET.urlencode }}"
       class="btn btn-success">
      <i class="bi bi-file-earmark-excel"></i> Baixar Excel
    </a>
  </div>

  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Projeto</th>
        <th>Coordenador</th>
        <th>Fornecedor</th>
        <th>Data Prevista</th>
        <th>Valor Previsto</th>
        <th>Data Pagamento</th>
        <th>Valor Pago</th>
      </tr>
    </thead>
    <tbody>
      {% for item in pagamentos %}
      <tr>
        <td>{{ item.contrato_terceiro__cod_projeto__cod_projeto }}</td>
        <td>{{ item.contrato_terceiro__coordenador__username }}</td>
        <td>{{ item.empresa_terceira__nome }}</td>
        <td>{{ item.data_prevista_pagamento|date:"d/m/Y" }}</td>
        <td>R$ {{ item.valor_previsto|floatformat:2 }}</td>
        <td>{% if item.data_pagamento %}{{ item.data_pagamento|date:"d/m/Y" }}{% endif %}</td>
        <td>R$ {{ item.valor_pago|floatformat:2 }}</td>
      </tr>
      {% endfor %}
      <tr class="fw-bold">
        <td colspan="4">Total Geral</td>
        <td>R$ {{ total_previsto|floatformat:2 }}</td>
        <td></td>
        <td>R$ {{ total_pago|floatformat:2 }}</td>
      </tr>
    </tbody>
  </table>

  {% if bms %}
  <div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mt-5">
      <h4>Boletins de Medi√ß√£o (BMs) com Pagamento no Per√≠odo</h4>
      <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'download_bms_aprovados' %}" class="btn btn-success">
          <i class="bi bi-download"></i> Baixar BMs Aprovados (.zip)
        </a>
      </div>
    </div>

    <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Projeto</th>
        <th>Coordenador</th>
        <th>N¬∫ BM</th>
        <th>Valor Pago</th>
        <th>Data de Pagamento</th>
        <th>Status</th>
        <th>Falta Aprovar</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for bm in bms %}
        <tr>
          <td>{{ bm.contrato.cod_projeto.cod_projeto }}</td>
          <td>{{ bm.contrato.coordenador.username }}</td>
          <td>{{ bm.numero_bm }}</td>
          <td>R$ {{ bm.valor_pago|floatformat:2 }}</td>
          <td>{{ bm.data_pagamento|date:"d/m/Y" }}</td>
          <td>{{ bm.status_geral }}</td>
          <td>
            {% if bm.falta_aprovar == '-' %}
              <span class="text-success">Nenhum</span>
            {% else %}
              <span class="text-warning">{{ bm.falta_aprovar }}</span>
            {% endif %}
          </td>
          <td>
            {% if bm.evento %}

              {% if request.user.grupo == 'suprimento' %}
                <a href="{% url 'detalhes_entrega' bm.evento.id %}" target="_blank"
                   class="btn btn-sm btn-outline-success">
                  <i class="bi bi-eye"></i> Verificar
                </a>
              {% elif request.user.grupo == 'gerente' %}
                {% if bm.status_gerente == 'pendente' %}
                  <a href="{% url 'detalhes_entrega' bm.evento.id %}" target="_blank"
                     class="btn btn-sm btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Aprovar
                  </a>
                {% elif bm.status_gerente == 'aprovado' %}
                  <a href="{% url 'detalhes_entrega' bm.evento.id %}" target="_blank"
                     class="btn btn-sm btn-outline-success">
                    <i class="bi bi-eye"></i> Verificar
                  </a>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            {% else %}
              <span class="text-muted">Sem evento</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}

      <!-- üî∏ Linha de total geral -->
      <tr class="fw-bold table-secondary">
        <td colspan="3" class="text-end">Total Geral:</td>
        <td>R$ {{ total_bm_pago|floatformat:2 }}</td>
        <td colspan="4"></td>
      </tr>
    </tbody>
  </table>

  </div>
  {% endif %}

  {% if grafico_html %}
    <h4 class="mt-5">Gr√°fico de Pagamentos Acumulados</h4>
    {{ grafico_html|safe }}
  {% endif %}

  {% elif form.is_bound %}
    <div class="alert alert-warning">Nenhum pagamento previsto at√© esta data.</div>
  {% endif %}
</div>

{% if grafico_barras %}
  <div class="mt-5">
    <h4>Pagamentos Previsto por Coordenadores</h4>
    {{ grafico_barras|safe }}
  </div>
{% endif %}

{% if grafico_barras_projeto %}
  <div class="mt-5">
    <h4>Pagamentos Previsto por Projetos</h4>
    {{ grafico_barras_projeto|safe }}
  </div>
{% endif %}

{% if grafico_barra %}
  <div class="mt-5">
    <h4>Pagamentos Previsto x Pago (√öltimos 12 meses e Pr√≥ximos 12 meses)</h4>
    {{ grafico_barra|safe }}
  </div>
{% endif %}
{% endblock %}
