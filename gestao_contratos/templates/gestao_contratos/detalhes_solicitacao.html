{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    <h2>Detalhes da Solicitação</h2>

<div class="timeline">
    <!-- barra de progresso -->
     <div id="timeline-progress" class="timeline-progress"></div>

    {% for status in status_order %}
        {% if forloop.counter0 < current_index %}
            <div class="step completed">
                <div class="circle">{{ forloop.counter }}</div>
                <span>{{ status }}</span>
            </div>
        {% elif forloop.counter0 == current_index %}
            <div class="step active">
                <div class="circle">{{ forloop.counter }}</div>
                <span>{{ status }}</span>
            </div>
        {% else %}
            <div class="step">
                <div class="circle">{{ forloop.counter }}</div>
                <span>{{ status }}</span>
            </div>
        {% endif %}
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const progressBar = document.getElementById("timeline-progress");
    const targetWidth = "{{ progress_percent }}%"; // vindo da view
    setTimeout(() => {
        progressBar.style.width = targetWidth;
    }, 200); // atraso pequeno para garantir a animação
});
</script>

<!-- Dados gerais da solicitação -->
<div class="card mb-3">
    <div class="card-body">
        <p><strong>Contrato:</strong> {{ solicitacao.contrato }}</p>
        <p><strong>Coordenador:</strong> {{ solicitacao.coordenador }}</p>
        <p><strong>Descrição:</strong> {{ solicitacao.descricao }}</p>
        <p><strong>Previsto no Orçamento:</strong>
            {% if solicitacao.previsto_no_orcamento %}✔️{% else %}<span style="color:red;">✖</span>{% endif %}
        </p>
        <p><strong>Valor Provisionado:</strong> {{ solicitacao.valor_provisionado }}</p>
        <p><strong>Valor Vendido:</strong> {{ solicitacao.valor_vendido }}</p>
        <p><strong>Data da Solicitação:</strong> {{ solicitacao.data_solicitacao|date:"d/m/Y H:i" }}</p>
        <p><strong>Data da Aprovação:</strong> {{ solicitacao.data_aprovacao|date:"d/m/Y H:i" }}</p>
        <p><strong>Aprovado por:</strong> {{ solicitacao.aprovado_por }}</p>
        <p><strong>Status:</strong> {{ solicitacao.status }}</p>
        <p><strong>Triagem Realizada:</strong>
            {% if solicitacao.triagem_realizada %}✔️{% else %}<span style="color:red;">✖</span>{% endif %}
        </p>
        <p><strong>Arquivo do Contrato:</strong>
            {% if solicitacao.contrato and solicitacao.contrato.arquivo_contrato %}
                <a href="{{ solicitacao.contrato.arquivo_contrato.url }}" target="_blank">Ver PDF</a>
            {% else %}
                -
            {% endif %}
        </p>
        <p><strong>Justificativa da Gerência:</strong> {{ solicitacao.justificativa_gerencia }}</p>
    </div>
</div>

<!-- Fornecedor escolhido -->
{% if solicitacao.fornecedor_escolhido %}
<div class="card mb-3">
    <div class="card-header">Fornecedor Escolhido</div>
    <div class="card-body">
        <p><strong>Nome:</strong> {{ solicitacao.fornecedor_escolhido.nome }}</p>
        <p><strong>Setor de Atuação:</strong> {{ solicitacao.fornecedor_escolhido.setor_de_atuacao }}</p>

        {% if proposta_escolhida %}
            <p><strong>Valor Total da Proposta:</strong> R$ {{ proposta_escolhida.valor_proposta|floatformat:2 }}</p>
            <p><strong>Prazo de Validade:</strong> {{ proposta_escolhida.prazo_validade|date:"d/m/Y" }}</p>
            {% if proposta_escolhida.arquivo_proposta %}
                <p><a href="{{ proposta_escolhida.arquivo_proposta.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver Proposta em PDF</a></p>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- Indicadores -->
<div class="card mb-3">
    <div class="card-header">Indicadores do Fornecedor Escolhido</div>
    <div class="card-body">
        {% if indicadores %}
            <ul>
                {% for ind in indicadores %}
                    <li>Entregas Totais: {{ ind.entregas_total }}</li>
                    <li>Entregas Conformes: {{ ind.entregas_conformes }}</li>
                    <li>Entregas Não Conformes: {{ ind.entregas_nao_conformes }}</li>
                    <li>IQ: {{ ind.IQ|floatformat:2 }}%</li>
                    <li>Entregas Pontuais: {{ ind.entregas_pontuais }}</li>
                    <li>IP: {{ ind.IP|floatformat:2 }}%</li>
                    <li>INC: {{ ind.INC|floatformat:2 }}%</li>
                    <li>IS: {{ ind.IS|floatformat:2 }}%</li>
                {% endfor %}
            </ul>
        {% else %}
            <p><em>Nenhum indicador cadastrado para este fornecedor.</em></p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Fornecedores selecionados na triagem -->
<div class="card mb-3">
    <div class="card-header">Fornecedores Selecionados na Triagem</div>
    <div class="card-body">
        {% if solicitacao.fornecedores_selecionados.all %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Setor de Atuação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in solicitacao.fornecedores_selecionados.all %}
                    <tr>
                        <td>{{ f.nome }}</td>
                        <td>{{ f.setor_de_atuacao }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Nenhum fornecedor selecionado.</p>
        {% endif %}
    </div>
</div>

<!-- Aprovação e Justificativa da Gerência -->
<div class="card mb-3">
    <div class="card-header">Avaliação da contratação pela Gerência</div>
    <div class="card-body">
        <p><strong>Aprovação da Gerência:</strong>
            {% if solicitacao.aprovacao_gerencia %}
                ✔️ Aprovado
            {% elif solicitacao.reprovacao_gerencia %}
                <span style="color:red;">✖ Reprovado</span>
            {% else %}
              Em analise
            {% endif %}
        </p>
        <p><strong>Justificativa da Gerência:</strong>
            {{ solicitacao.justificativa_gerencia|default:"-" }}
        </p>
    </div>
</div>

<!-- Eventos -->

  <div class="card mb-3">
      <div class="card-header">Eventos da Solicitação</div>
      <div class="card-body">
          {% if eventos %}
              <table class="table table-striped">
                  <thead>
                      <tr>
                          <th>Descrição</th>
                          <th>Data Prevista</th>
                          <th>Valor Previsto</th>
                          <th>Realizado</th>
                          <th>Com Atraso</th>
                          <th>Valor Pago</th>
                          <th>Ações</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for evento in eventos %}
                      <tr>
                          <td>{{ evento.descricao }}</td>
                          <td>{{ evento.data_prevista|date:"d/m/Y" }}</td>
                          <td>R$ {{ evento.valor_previsto|default:"-" }}</td>
                          <td>{% if evento.realizado %}✔️{% else %}✖{% endif %}</td>
                          <td>{% if evento.com_atraso %}✔️{% else %}✖{% endif %}</td>
                          <td>R$ {{ evento.valor_pago|default:"-" }}</td>
                          <td>
                            {% if request.user.grupo == 'suprimento' %}
                              <a href="{% url 'editar_evento' evento.id %}" class="btn btn-sm btn-warning">Editar</a>
                              <a href="{% url 'excluir_evento' evento.id %}" class="btn btn-sm btn-danger"
                                 onclick="return confirm('Tem certeza que deseja excluir este evento?')">
                                 Apagar
                              </a>
                            {% endif %}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          {% else %}
              <p><em>Nenhum evento cadastrado para esta solicitação.</em></p>
          {% endif %}
          {% if request.user.grupo == 'suprimento' %}
              <a href="{% url 'cadastrar_evento' solicitacao.id %}" class="btn btn-primary mt-2">Cadastrar Evento</a>
          {% elif request.user.grupo == 'coordenador' and solicitacao.status == "Solicitação de prospecção" %}
              <a href="{% url 'cadastrar_evento' solicitacao.id %}" class="btn btn-primary mt-2">Cadastrar Evento</a>
          {% elif request.user.grupo == 'coordenador' and solicitacao.aprovacao_fornecedor_gerente == "aprovado" %}
              <a href="{% url 'cadastrar_evento' solicitacao.id %}" class="btn btn-primary mt-2">Cadastrar Evento</a>
          {% endif %}
      </div>
  </div>

<hr>
  <h4>Histórico</h4>

  {% if origem %}
      <p><strong>Solicitação de Origem:</strong>
         <a href="{% url 'detalhes_contrato' origem.pk %}">{{ origem.contrato }}</a>
      </p>
  {% endif %}

  {% if revisoes %}
      <p><strong>Revisões criadas a partir desta:</strong></p>
      <ul>
          {% for revisao in revisoes %}
              <li>
                  <a href="{% url 'detalhes_contrato' revisao.pk %}">
                      {{ revisao.contrato }} - Criada em {{ revisao.criado_em|date:"d/m/Y H:i" }}
                  </a>
              </li>
          {% endfor %}
      </ul>
  {% else %}
      <p>Sem revisões relacionadas.</p>
  {% endif %}

{% if request.user.grupo == 'suprimento' %}
  {% if solicitacao.reprovacao_gerencia  %}
    <div class="card mb-3">
      <a href="{% url 'nova_prospeccao' solicitacao.id %}" class="btn btn-sm btn-primary">Nova Prospecção</a>
      <a href="{% url 'renegociar_valor' solicitacao.id %}" class="btn btn-sm btn-warning">Renegociar Valor</a>
      <a href="{% url 'renegociar_prazo' solicitacao.id %}" class="btn btn-sm btn-info">Renegociar Prazo</a>
    </div>
  {% endif %}
{% endif %}

<!-- Botões de aprovação para gerente -->
{% if request.user.grupo == 'gerente' and solicitacao.contrato and solicitacao.contrato.arquivo_contrato %}
    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="justificativa" class="form-label">Justificativa (se reprovar)</label>
            <textarea class="form-control" name="justificativa" id="justificativa" rows="3"></textarea>
        </div>
        <button type="submit" name="acao" value="aprovar" class="btn btn-success">Aprovar</button>
        <button type="submit" name="acao" value="reprovar" class="btn btn-danger">Reprovar</button>
    </form>
{% endif %}

<a href="{% url 'elaboracao_contrato' %}" class="btn btn-secondary mt-3">Voltar</a>


</div>

{% endblock %}
